# Experiments {#sec-experiments}

We seek to answer the following three research questions:

1. To what extent does the CT objective in Equation 1 induce models to learn plausible explanations?
2. To what extent does the CT objective produce more favorable algorithmic recourse outcomes in the presence of actionability constraints?
3. What are the effects of hyperparameter selection wrt. the CT objective?

## Experimental Setup

Our key outcome of interest is improvement in explainability (Def. \ref{def-explainability}). Thus, we focus primarily on the plausibility and cost of faithfully generated counterfactuals at test time^[Additional metrics such as validity and redundancy are reported in the appendix.]. To measure the cost, we follow the standard convention of using distances ($\ell_1$-norm) between factuals and counterfactuals as a proxy. For plausibility, we assess how similar CEs are to the observed samples in the target domain, $\mathbf{X}^+\subset\mathcal{X}^+$. We rely on the metric used by @altmeyer2024faithful,
$$
\text{IP}(\mathbf{x}^\prime,\mathbf{X}^+) = \frac{1}{\lvert\mathbf{X}^+\rvert}\sum_{\mathbf{x} \in \mathbf{X}^+} \text{dist}(\mathbf{x}^{\prime},\mathbf{x})
$$ {#eq-impl-dist}
and introduce a novel divergence metric,
$$
\text{IP}^*(\mathbf{X}^\prime,\mathbf{X}^+) = \text{MMD}(\mathbf{X}^\prime,\mathbf{X}^+)
$$ {#eq-impl-div}
where $\mathbf{X}^\prime$ denotes a collection of counterfactuals and $\text{MMD}(\cdot)$ is the unbiased estimate of the squared population maximum mean discrepancy, proposed by @gretton2012kernel. The metric in @eq-impl-div is equal to zero if and only if the two distributions are exactly the same, $\mathbf{X}^\prime=\mathbf{X}^+$.

We also assess the predictive performance of models using standard metrics, including robust accuracy estimated on adversarially perturbed data using FGSM [@goodfellow2014explaining].

We run experiments with three gradient-based generators: *Generic* of @wachter2017counterfactual as a simple baseline approach, *REVISE* [@joshi2019realistic] that aims to generate plausible counterfactuals using a surrogate Variational Autoencoder (VAE), and *ECCo*---the generator of @altmeyer2024faithful but without the conformal prediction component---as a method that directly targets both faithfulness and plausibility of the counterfactuals.

We make use of nine classification datasets common in the CE/AR literature. Four of them are synthetic with two classes and different characteristics: linearly separable clusters (*LS*), overlapping clusters (*OL*), concentric circles (*Circ*), and interlocking moons (*Moon*). These datasets are generated using the library of @altmeyer2023explaining and we present them in the supplementary appendix. Next, we have four real-world binary tabular datasets from the domain of economics: *Adult* (a.k.a. Census data) of @becker1996adult2, California housing (*CH*) of @pace1997sparse, Default of Credit Card Clients (*Cred*) of @yeh2016default, and Give Me Some Credit (*GMSC*) from @kaggle2011give2. Finally, for the convenience of illustration, we use the 10-class *MNIST* dataset [@lecun1998mnist].

To assess CT, we investigate the improvements in performance metrics when using it on top of a weak baseline (BL): a multilayer perceptron (*MLP*). This is the best way to get a clear picture of the effectiveness of CT, and it is consistent with evaluation practices in the related literature [@goodfellow2014explaining;@ross2021learning;@teney2020learning].

## Experimental Results

Our main quantitative results for the *MLP* are summarised in @tbl-main, which shows average outcomes along with bootstrapped standard errors for key metrics. The following example illustrates how to read @tbl-main.

![Illustration of how CT improves model explainability: (a) conventional training, all mutable; (b) CT, all mutable; (c) conventional, *age* immutable; (d) CT, *age* immutable. The linear decision boundary is shown in green along with training data colored according to ground-truth labels: $y^-=1$ (blue) and $y^+=2$ (orange). Stars indicate counterfactuals in the target class.](/paper/figures/poc.svg){#fig-poc fig-env="figure*"}

### Synthetic Example: Prediction of Credit Defaults

@fig-poc presents results for a linear classifier fitted to *LS*, which complies with the data assumptions in Proposition \ref{prp-mtblty}. The four panels show the outcomes for different training procedures: in panels (a) and (c) we have trained the models conventionally, while in panels (b) and (d) we have applied CT. For illustrative purposes, suppose the first feature represents *debt* (mutable) and the second feature represents *age* (immutable) of loan applicants seeking counterfactual explanations for moving to the target class: loan provided (orange).

In all four cases, it is possible to generate valid counterfactuals (stars) for unsuccessful applicants (blue). They cross the decision boundary (green) into the target class, but their quality differs. In panel (a), they are not plausible: they do not comply with the distribution of the factuals in $y^+$ to the point where they form a clearly discernible cluster. In panel (b), they are highly plausible, meeting the first objective of Def. \ref{def-explainability}. This difference in outcomes is quantified for the non-linear MLP in the first two columns of @tbl-main as the $\%$-reduction in implausibility: it is substantial and statistically significant for *LS* across both metrics, the distance-based $IP$ (29%) and divergence-based $IP^{*}$ (55%).

In panel (c) of @fig-poc, the CEs involve substantial reductions in *debt* for younger applicants. By comparison, counterfactual paths are shorter on average in panel (d) where we have protected the immutable *age* as described in @sec-constraints. Due to the classifier's lower sensitivity to *age*, recommendations with respect to *debt* are much more homogenous and do not unfairly punish younger individuals. These counterfactuals are also plausible with respect to the mutable feature, despite requiring smaller debt reductions on average, resulting in smaller costs to individuals. This result is quantified for the non-linear case in column three of @tbl-main, which shows the $\%$-reduction in costs averaged across valid counterfactuals. Once again, the impact of CT is statistically significant and substantial (14%). Thus, we consider the model in panel (d) as the most explainable according to Def. \ref{def-explainability}. In the following, we present the results for all remaining datasets.

### Plausibility. {#sec-plaus}

We find that CT generally leads to substantial and statistically significant improvements in plausibility: average reductions in $IP$ range from around 7% for *MNIST* to almost 60% for *Circ*; for the real-world tabular datasets they are around 12% for both *CH* and *Cred* and almost 25% for *GMSC*; for *Adult* and *OL* we find no significant impact of CT on $IP$. Reductions in $IP^{*}$ are even more substantial and generally statistically significant, although the average degree of uncertainty is higher than for $IP$: average reductions range from around 20% (*Moons*) to almost 90% (*Circ*). The only negative findings for *OL* and *MNIST* are statistically insignificant and, in the latter case, do not align with qualitative findings, which are much more plausible for CT (@fig-mnist).

![Explanations for *MNIST* for BL (top) and CT (bottom). First column is a random factual 0. Columns 2 to 5 are corresponding *ECCo* counterfactuals in target classes 1 to 4. Columns 6 to 10 show integrated gradients averaged over all test images in classes 5 to 9.](/paper/figures/mnist_body.png){#fig-mnist}

### Actionability. {#sec-act}

We also find that CT can reduce sensitivity to immutable, protected features and thus lead to less costly counterfactual outcomes as illustrated in @fig-poc. In column three of @tbl-main, we impose mutability constraints on selected features and compute the reduction in average costs of counterfactuals associated with CT compared to the weak baseline: for synthetic datasets, we always protect the first feature; for all real-world tabular datasets we could identify and protect an *age* variable; for *MNIST*, we protect the five top and bottom rows of digits. Reductions in costs are overwhelmingly positive and significant of up to nearly 60% for *GMSC*. While the estimated cost reductions for *Adult* and *MNIST* are not significant, @fig-mnist demonstrates that CT does have the expected effect: sensitivity to protected features as proxied by integrated gradients is drastically reduced^[Additional findings for integrated gradients are reported in the appendix.]. In the case of *Cred*, average costs increase, likely because any potential benefits from protecting the *age* are outweighed by the increase in costs required for greater plausibility.

### Predictive Performance. {#sec-pred} 

Test accuracy for CT is virtually identical to the baseline for *Adult*, *Circ*, *LS*, *Moon*, and *OL*, and even slightly improved for *Cred*. Exceptions to this general pattern are *MNIST*, *CH*, and *GMSC*, for which we observe a reduction in test accuracy of 2, 5, and 15 percentage points respectively. When looking at robust test accuracies (Acc.$^*$) for these datasets in particular, we find that CT strongly outperforms the baseline. In fact, we observe that CT improves adversarial robustness on all datasets. 

<!-- Final Results -->
<!---->
<!-- Columns 1-3 show mean outcome +- TWO (2) bootstrapped standard errors. -->
<!---->
<!-- - IP: significant and in many cases substantial reduction in implausibility, except for OL and Adult (both insfignficant) -->
<!-- - IP*: significant and in many cases substantial reduction (up to 90%) in implausibility, except for MNIST and OL. -->
<!-- - Cost: significant and in some cases substantial reduction, except for Adult, MNIST (both insignificant) and Credit (significant increase in costs). -->

::: {#tbl-main}

```{=latex}
\begin{table*}
\input{tables/main.tex}
\end{table*}
```

Key performance metrics and bootstrapped standard errors for all datasets. **Plausibility** (columns 1-2): percentage reduction in implausibility for $IP$ and $IP^*$, respectively; **Actionability** (column 3): percentage reduction in costs with protected features. **Accuracy** (columns 4-7): test accuracies and robust accuracies ($\text{Acc}^*$) for CT and the baseline (BL). Counterfactual outcomes in columns 1-3 are aggregated across bootstrap samples and varying degrees of the energy penalty $\lambda_{\text{egy}}$ used for *ECCo* at test time. Standard errors for accuracy are bootstrapped from the test set.
:::

### Hyperparameter settings. {#sec-hyperparameters}
We test the impact of three types of hyperparameters. Here we focus on the highlights; full results are available in the supplementary appendix.  
`\indent`{=latex} First, we note that CT is highly sensitive to the choice of a CE generator and its hyperparameters but (1) there are manageable patterns, and (2) we can usually identify settings that improve either plausibility or cost, and often both of them at the same time. For example, *REVISE* tends to perform the worst, most likely because it uses a surrogate VAE to generate counterfactuals which impedes faithfulness [@altmeyer2024faithful]. Increasing $T$, the maximum number of steps, generally yields better outcomes because more CEs can mature in each training epoch. The impact of $\tau$, the required decision threshold is more difficult to predict. On "harder" datasets it may be difficult to satisfy high $\tau$ for any given sample (i.e., also factuals) and so increasing this threshold does not seem to correlate with better outcomes. In fact, $\tau=0.5$ generally leads to optimal results as it is associated with high proportions of mature counterfactuals.  
`\indent`{=latex} Second, the strength of the energy regularization, $\lambda_{\text{reg}}$ is highly impactful and leads to poor performance in terms of decreased plausibility and increased costs if insufficiently high. The sensitivity with respect to $\lambda_{\text{div}}$ and $\lambda_{\text{adv}}$ is much less evident. While high values of $\lambda_{\text{reg}}$ may increase the variability in outcomes when combined with high values of $\lambda_{\text{div}}$ or $\lambda_{\text{adv}}$, this effect is not very pronounced.   
`\indent`{=latex} Third, the effectiveness and stability of CT is positively associated with the number of counterfactuals generated during each training epoch. A higher number of training epochs is also beneficial. Interestingly, we observed desired improvements when CT was combined with conventional training and applied only for the final 50% of epochs of the complete training process. Put differently, CT can improve the explainability of models in a fine-tuning manner. 
