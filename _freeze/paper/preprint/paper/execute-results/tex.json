{
  "hash": "a8223ddf51e2a9e9ebe8fff23a588627",
  "result": {
    "engine": "julia",
    "markdown": "---\nengine: julia\njulia: \n  exeflags: [\"--project=../experiments/\"]\nformat:\n  arxiv-pdf:\n    keep-tex: true  \n    linenumbers: true\n    doublespacing: false\n    runninghead: \"Counterfactual Training (A Preprint)\"\n    authorcols: true\n---\n\n\n# Abstract\n\nCounterfactual Explanations have emerged as a popular tool to explain predictions made by opaque machine learning models: they explain how factual inputs need to change in order for some fitted model to produce some desired output. Much existing research has focused on identifying explanations that are not only valid but also deemed plausible and desirable with respect to the underlying data and stakeholder requirements. Recent work has shown that under this premise, the task of learning plausible explanations is effectively reassigned from the model itself to the (post-hoc) counterfactual explainer. Building on that work, we propose a novel model objective that leverages counterfactuals during the training phase (ad-hoc) in order to minimize the divergence between learned representations and plausible explanations. Through extensive experiments, we demonstrate that our proposed methodology facilitates training models that inherently deliver plausible explanations while maintaining high predictive performance. \n\n\n\n# Introduction\n\nToday's prominence of artificial intelligence (AI) has largely been driven by advances in **representation learning**: instead of relying on features and rules that are carefully hand-crafted by humans, modern machine learning (ML) models are tasked with learning these representations from scratch, guided by narrow objectives such as predictive accuracy [@goodfellow2016deep]. Modern advances in computing have made it possible to provide such models with ever greater degrees of freedom to achieve that task, which has often led them to outperform traditionally more parsimonious models. Unfortunately, in doing so they also learn increasingly complex and highly sensitive representations that we can no longer easily interpret.\n\nThis trend towards complexity for the sake of performance has come under serious scrutiny in recent years. At the very cusp of the deep learning revolution, @szegedy2013intriguing showed that artificial neural networks (ANN) are sensitive to adversarial examples: counterfactuals of model inputs that yield vastly different model predictions despite being \"imperceptible\" in that they are semantically indifferent from their factual counterparts. Despite partially effective mitigation strategies such as **adversarial training** [@goodfellow2014explaining], truly robust deep learning (DL) remains unattainable even for models that are considered shallow by today's standards [@kolter2023keynote]. \n\nPart of the problem is that high degrees of freedom provide room for many solutions that are locally optimal with respect to narrow objectives [@wilson2020case]^[For clarity: we follow standard ML convention in using \"degrees of freedom\" to refer to the number of parameters estimated from data.]. Based purely on predictive performance, these solutions may seem to provide compelling explanations for the data, when in fact they are based on purely associative, semantically meaningless patterns. This poses two related challenges: firstly, it makes these models inherently opaque, since humans cannot simply interpret what type of explanation the complex learned representations correspond to; secondly, even if we could resolve the first challenge, it is not obvious how to mitigate models from learning representations that correspond to meaningless and implausible explanations. \n\nThe first challenge has attracted an abundance of research on **explainable AI** (XAI) which aims to develop tools to derive explanations from complex model representations. This can mitigate a scenario in which we deploy opaque models and blindly rely on their predictions. On countless occasions, this scenario has already occurred in practice and caused real harm to people who were affected adversely and often unfairly by automated decision-making systems (ADMS) involving opaque models [@oneil2016weapons]. Effective XAI tools can aide us in monitoring models and providing recourse to individuals to turn adverse outcomes (e.g. \"loan application rejected\") into positive ones (\"application accepted\"). @wachter2017counterfactual propose **counterfactual explanations** as an effective approach to achieve this: they explain how factual inputs need to change in order for some fitted model to produce some desired output, typically involving minimal perturbations.\n\nTo our surprise, the second challenge has not yet attracted any consolidated research effort. Specifically, there has been no concerted effort towards improving model **explainability**, which we define here as the degree to which learned representations correspond to explanations that are interpretable and deemed **plausible** by humans (see @def-explainability). Instead, the choice has typically been to improve the capacity of XAI tools to identify the subset explanations that are both plausible and valid for any given model, independent of whether the learned representations are also compatible with implausible explanations [@altmeyer2024faithful]. Fortunately, recent findings indicate that explainability can arise as byproduct of regularization techniques aimed at other objectives such as robustness, generalization and generative capacity [@schut2021generating, @augustin2020adversarial, @altmeyer2024faithful]. \n\nBuilding on these findings, we introduce **counterfactual training**: a novel regularization technique geared explicitly towards aligning model representations with plausible explanations. Our contributions are as follows:\n\n- We discuss existing related work on improving models and consolidate it through the lens of counterfactual explanations (@sec-lit).\n- We present our proposed methodological framework that leverages faithful counterfactual explanations during the training phase of models to achieve the explainability objective (@sec-method).\n- Through extensive experiments we demonstrate the counterfactual training improve model explainability while maintaining high predictive performance. We run ablation studies and grid searches to understand how the underlying model components and hyperparameters affect outcomes. (@sec-experiments). \n\nDespite limitations of our approach discussed in @sec-discussion, we conclude that counterfactual training provides a practical framework for researchers and practitioners interested in making opaque models more trustworthy [@sec-conclusion]. We also believe that this work serves as an opportunity for XAI researchers to reevaluate the premise of improving XAI tools without improving models. \n\n\n\n\n# Related Literature {#sec-lit}\n\nTo the best of our knowledge, our proposed framework for counterfactual training represents the first attempt to use counterfactual explanations during training to improve model explainability. In high-level terms, we define model explainability as the extent to which valid explanations derived for an opaque model are also deemed plausible with respect to the underlying data and stakeholder requirements. To make this more concrete, we follow @augustin2020adversarial in tieing the concept of explainability to the quality of counterfactual explanations that we can generate for a given model. The authors show that counterfactual explanations---understood here as minimal input perturbations that yield some desired model prediction---are generally more meaningful if the underlying model is more robust to adversarial examples. We can make intuitive sense of this finding when looking at adversarial training (AT) through the lens of representation learning with high degrees of freedom: by inducing models to \"unlearn\" representations that are susceptible to worst-case counterfactuals (i.e. adversarial examples), AT effectively removes some implausible explanations from the solution space.\n\n## Adversarial Examples are Counterfactual Explanations\n\nThis interpretation of the link between explainability through counterfactuals on one side, and robustness to adversarial examples on the other, is backed by empirical evidence. @sauer2021counterfactual demonstrate that using counterfactual images during classifier training improves model robustness. Similarly, @abbasnejad2020counterfactual argue that counterfactuals represent potentially useful training data in machine learning, especially in supervised settings where inputs may be reasonably mapped to multiple outputs. They, too, demonstrate the augmenting the training data of image classifiers can improve generalization. @teney2020learning propose an approach using counterfactuals in training that does not rely on data augmentation: they argue that counterfactual pairs typically already exist in training datasets. Specifically, their approach relies on, firstly, identifying similar input samples with different annotations and, secondly, ensuring that the gradient of the classifier aligns with the vector between pairs of counterfactual inputs using the cosine distance as a loss function. In the natural language processing (NLP) domain, counterfactuals have similarly been used to improve models through data augmentation: @wu2021polyjuice, propose *POLYJUICE*, a general-purpose counterfactual generator for language models. They demonstrate empirically that augmenting training data through *POLYJUICE* counterfactuals improves robustness in a number of NLP tasks. @luu2023counterfactual introduce Counterfactual Adversarial Training (CAT), which also aims at improving generalization and robustness of language models. Specifically, they propose to proceed as follows: firstly, they identify training samples that are subject to high predictive uncertainty; secondly, they generate counterfactual explanations for those samples; and, finally, they fine-tune the given language model on the augmented dataset that includes the generated counterfactuals. \n\nThere have also been several attempts at formalizing the relationship between counterfactual explanations (CE) and adversarial examples (AE). Pointing to clear similarities in how CE and AE are generated, @freiesleben2022intriguing makes the case for jointly studying the opaqueness and robustness problem in representation learning. Formally, AE can be seen as the subset of CE, for which misclassification is achieved [@freiesleben2022intriguing]. Similarly, @pawelczyk2022exploring show that CE and AE are equivalent under certain conditions and derive theoretical upper bounds on the distances between them. \n\nTwo recent works are closely related to ours in that they use counterfactuals during training with the explicit goal of affecting certain properties of post-hoc counterfactual explanations. Firstly, @ross2021learning propose a way to train models that are guaranteed to provide recourse for individuals to move from an adverse outcome to some positive target class with high probability. The approach proposed by @ross2021learning builds on adversarial training, where in this context susceptibility to targeted adversarial examples for the positive class is explicitly induced. The proposed method allows for imposing a set of actionability constraints ex-ante: for example, users can specify that certain features (e.g. *age*, *gender*, ...) are immutable. Secondly, @guo2023counternet are the first to propose an end-to-end training pipeline that includes counterfactual explanations as part of the training procedure. In particular, they propose a specific network architecture that includes a predictor and CE generator network, where the parameters of the CE generator network are learnable. Counterfactuals are generated during each training iteration and fed back to the predictor network. In contrast to @guo2023counternet, we impose no restrictions on the neural network architecture at all. \n\n## Beyond Robustness \n\nImproving the adversarial robustness of models is not the only path towards aligning representations with plausible explanations. In a work closely related to this one, @altmeyer2024faithful show that explainability can be improved through model averaging and refined model objectives. The authors propose a way to generate counterfactuals that are maximally **faithful** to the model in that they are consistent with what the model has learned about the underlying data. Formally, they rely on tools from energy-based modelling to minimize the divergence between the distribution of counterfactuals and the conditional posterior over inputs learned by the model. Their proposed counterfactual explainer, *ECCCo*, yields plausible explanations if and only if the underlying model has learned representations that align with them. They find that both deep ensembles [@lakshminarayanan2016simple] and joint energy-based models (JEMs) [@grathwohl2020your] tend to do well in this regard. \n\nOnce again it helps to look at these findings through the lens of representation learning with high degrees of freedom. Deep ensembles are approximate Bayesian model averages, which are most called for when models are underspecified by the available data [@wilson2020case]. Averaging across solutions mitigates the aforementioned risk of relying on a single locally optimal representations that corresponds to semantically meaningless explanations for the data. Previous work by @schut2021generating similarly found that generating plausible (\"interpretable\") counterfactual explanations is almost trivial for deep ensembles that have also undergone adversarial training. The case for JEMs is even clearer: they involve a hybrid objective that induces both high predictive performance and generative capacity [@grathwohl2020your]. This is closely related to the idea of aligning models with plausible explanations and has inspired our proposed counterfactual training objective, as we explain in @sec-method.\n\n\n\n# Counterfactual Training {#sec-method}\n\nCounterfactual training combines ideas from adversarial training, energy-based modelling and counterfactuals explanations with the explicit objective of aligning representations with plausible explanations that comply with user requirements. In the context of CE, plausibility has broadly been defined as the degree to which counterfactuals comply with the underlying data generating process [@poyiadzi2020face;@guidotti2022counterfactual;@altmeyer2024faithful]. Plausibility is a necessary but insufficient condition for using CE to provide algorithmic recourse (AR) to individuals affected by opaque models in practice. This is because for recourse recommendations to be **actionable**, they need to not only result in plausible counterfactuals but also be attainable. A plausible CE for a rejected 20-year-old loan applicant, for example, might reveal that their application would have been accepted, if only they were 20 years older. Ignoring all other features, this complies with the definition of plausibility if 40-year-old individuals are in fact more credit-worthy on average than young adults. But of course this CE does not qualify for providing actionable recourse to the applicant since *age* is not a mutable feature. For our intents and purposes, counterfactual training aims at improving model explainability by aligning models with counterfactuals that meet both desiderata, plausibility and actionability. Formally, we define explainability as follows:\n\n::: {#def-explainability}\n\n## Model Explainability\n\nLet $\\mathbf{M}_\\theta: \\mathcal{X} \\mapsto \\mathcal{Y}$ denote a supervised classification model that maps from the $D$-dimensional input space $\\mathcal{X}$ to representations $\\phi(\\mathbf{x};\\theta)$ and finally to the $K$-dimensional output space $\\mathcal{Y}$. Assume that for any given input-output pair $\\{\\mathbf{x},\\mathbf{y}\\}_i$ there exists a counterfactual $\\mathbf{x}^{\\prime} = \\mathbf{x} + \\Delta: \\mathbf{M}_\\theta(\\mathbf{x}^{\\prime}) = \\mathbf{y}^{+} \\neq \\mathbf{y} = \\mathbf{M}_\\theta(\\mathbf{x})$ where $\\mathbf{y}^{+}$ denotes some target output. We say that $\\mathbf{M}_\\theta$ is **explainable** to the extent that faithfully generated counterfactuals are plausible (i.e. consistent with the data) and actionable. Formally, we define these properties as follows:\n\n1. (Plausibility) $\\int^{A} p(\\mathbf{x}|\\mathbf{y}^{+})d\\mathbf{x} \\rightarrow 1$ where $A$ is some small region around $\\mathbf{x}^{\\prime}$.\n2. (Actionability) Permutations $\\Delta$ are subject to actionability constraints.\n\nWe consider counterfactuals as faithful to the extent that they are consistent with what the model has learned about the input data. Let $p_\\theta(\\mathbf{x}|\\mathbf{y}^{+})$ denote the conditional posterior over inputs, then formally:\n\n3. (Faithfulness) $\\int^{A} p_\\theta(\\mathbf{x}|\\mathbf{y}^{+})d\\mathbf{x} \\rightarrow 1$ where $A$ is defined as above.\n\n:::\n\nThe definitions of faithfulness and plausibility in @def-explainability are the same as in @altmeyer2024faithful, with adapted notation. Actionability constraints in @def-explainability vary and depend on the context in which $\\mathbf{M}_\\theta$ is deployed. In this work, we focus on domain and mutability constraints for individual features $x_d$ for $d=1,...,D$. We limit ourselves to classification tasks for reasons discussed in @sec-discussion.\n\n## Our Proposed Objective\n\nTo train models with high explainability as defined in @def-explainability, we propose the following objective,\n\n$$\n\\text{yloss}(\\mathbf{M}_\\theta(\\mathbf{x}),\\mathbf{y}) + \\lambda_{\\text{div}} \\text{div}(\\mathbf{x},\\mathbf{x^\\prime},y;\\theta) + \\lambda_{\\text{adv}} \\text{advloss}(\\mathbf{M}_\\theta(\\mathbf{x^\\prime}),\\mathbf{y})\n$$ {#eq-obj}\n\nwhere $\\text{yloss}(\\cdot)$ denotes any conventional classification loss function (e.g. cross-entropy) that induces discriminative (predictive) performance. The two additional components in @eq-obj are explained in more detail below. For now, they can be sufficiently described as inducing explainability directly and indirectly by penalizing: 1) the contrastive divergence, $\\text{div}(\\cdot)$, between counterfactuals $x^\\prime$ and observed samples $x$ and, 2) the adversarial loss, $\\text{advloss}(.)$, with respect to counterfactuals. The tradeoff between the different components can be governed by adjusting the strengths of the penalties $\\lambda_{\\text{div}}$ and $\\lambda_{\\text{adv}}$.\n\n### Directly Inducing Explainability through Contrastive Divergence\n\n@grathwohl2020your observe that any classifier can be re-interpreted as a joint energy-based model (JEM) that learns to discriminate output classes conditional on inputs and generate inputs. They show that JEMs can be trained to perform well at both tasks by directly maximizing the joint log-likelihood factorized as $\\log p_\\theta(\\mathbf{x},\\mathbf{y})=\\log p_\\theta(\\mathbf{y}|\\mathbf{x}) + \\log p_\\theta(\\mathbf{x})$. The first factor can be optimized using conventional cross-entropy as in @eq-obj. To optimize $\\log p_\\theta(\\mathbf{x})$ @grathwohl2020your minimize the contrastive divergence between samples drawn from $p_\\theta(\\mathbf{x})$ and training observations, i.e. samples from $p(\\mathbf{x})$. \n\nA key empirical finding in @altmeyer2024faithful was that JEMs tend to do well with respect to the plausibility objective in @def-explainability. If we consider samples drawn from $p_\\theta(\\mathbf{x})$ as counterfactuals, this is an expected finding, because the JEM objective effectively minimizes the divergence between the conditional posterior and $p(\\mathbf{x}|\\mathbf{y}^{+})$. To generate samples, @grathwohl2020your rely on Stochastic Gradient Langevin Dynamics (SGLD) using an uninformative prior for initialization. This is where we depart from their methodology: instead of generating samples through SGLD, we propose using counterfactual explainers to generate counterfactuals for observed training samples. Specifically, we have\n\n$$\n\\text{div}(\\mathbf{x},\\mathbf{x^\\prime},y;\\theta) = \\mathcal{E}_\\theta(\\mathbf{x},y) - \\mathcal{E}_\\theta(\\mathbf{x}^\\prime,y)\n$$ {#eq-div}\n\nwhere $\\mathcal{E}_\\theta(\\cdot)$ denotes the energy function. We generate samples $\\mathbf{x}^\\prime$ by first randomly sampling the target class $y^+ \\sim p(y)$ and then generating a counterfactual explanation for that target, similar to how conditional sampling is used to draw from $p_\\theta(\\mathbf{x})$ in @grathwohl2020your. In particular, we set $\\mathcal{E}_\\theta(\\mathbf{x},\\mathbf{y})=-\\mathbf{M}_\\theta(\\mathbf{x})[y^+]$ where $y^+$ denotes the index of the target class.\n\nIntuitively, the gradient of @eq-div decreases the energy of observed training samples (positive samples) while at same time increasing the energy of counterfactuals (negative samples) [@du2019implicit]. As the generated counterfactuals get more plausible (@def-explainability) over the cause of training, these two opposing effects gradually balance each out [@lippe2024uvadlc]. \n\nThe departure from SGLD allows us to tap into the vast repertoire of explainers that have been proposed in the literature to meet different desiderata. Typically, these methods facilitate the imposition of domain and mutability constraints, for example. In principle, any existing approach for generating counterfactual explanations is viable, so long as it does not violate the faithfulness condition. Like JEMs [@murphy2022probabilistic], counterfactual training can be considered as a form of contrastive representation learning. \n\n### Indirectly Inducing Explainability through Adversarial Robustness\n\nBased on our analysis in @sec-lit, counterfactuals $\\mathbf{x}^\\prime$ can be repurposed as additional training samples [@luu2023counterfactual] or adversarial examples [@freiesleben2022intriguing;@pawelczyk2022exploring]. This leaves some flexibility with respect to the exact choice for $\\text{advloss}(\\cdot)$ in @eq-obj. An intuitive functional form to use, though likely not the only reasonable choice, is inspired by adversarial training:\n\n$$\n\\begin{aligned}\n\\text{advloss}(\\mathbf{M}_\\theta(\\mathbf{x^\\prime}),\\mathbf{y};\\varepsilon)&=\\begin{cases}\n\\text{yloss}(\\mathbf{M}_\\theta(\\mathbf{x^\\prime}),\\mathbf{y}) & \\text{if} \\ ||\\Delta||_\\infty \\leq \\varepsilon \\\\\n0 & \\text{otherwise.}\n\\end{cases}\n\\end{aligned}\n$$ {#eq-adv}\n\nUnder this choice we treat the counterfactual $\\mathbf{x}^\\prime$ as an adversarial example iff it is imperceptible, i.e. the magnitude of the perturbation of any individual feature is upper-bounded at $\\varepsilon$.\n\n## Encoding Actionability Constraints {#sec-constraints}\n\nMany existing counterfactual explainers support domain and mutability constraints out-of-the-box. In fact, both types of constraints can be implemented for any counterfactual explainer that relies on gradient descent in the feature space for optimization [@altmeyer2023explaining]. In this context, domain constraints can be imposed by simply projecting counterfactuals back to the specified domain, if the previous gradient step resulted in updated feature values that were out-of-domain. Mutability constraints can similarly be enforced by setting partial derivatives to zero to ensure that features are only mutated in the allowed direction, if at all. \n\nSince actionability constraints are binding at test time, we should also impose them when generating $\\mathbf{x}^\\prime$ during each training iteration to align model representations with user requirements. Through their effect on $\\mathbf{x}^\\prime$, both types of constraints influence model outcomes through @eq-div. Here it is crucial that we avoid penalizing implausibility that arises due to mutability constraints. For any mutability-constrained feature $d$ this can be achieved by enforcing $\\mathbf{x}[d] - \\mathbf{x}^\\prime[d]:=0$ whenever perturbing $\\mathbf{x}^\\prime[d]$ in the direction of $\\mathbf{x}[d]$ would violate mutability constraints. Specifically, we set $\\mathbf{x}[d] := \\mathbf{x}^\\prime[d]$ if \n\n1. Feature $d$ is strictly immutable in practice.\n2. We have $\\mathbf{x}[d]>\\mathbf{x}^\\prime[d]$ but feature $d$ can only be decreased in practice.\n3. We have $\\mathbf{x}[d]<\\mathbf{x}^\\prime[d]$ but feature $d$ can only be increased in practice.\n\nFrom a Bayesian perspective, setting $\\mathbf{x}[d] := \\mathbf{x}^\\prime[d]$ can be understood as assuming a point mass prior for $p(\\mathbf{x})$ with respect to feature $d$. Intuitively, we think of this simply in terms ignoring implausibility costs with respect to immutable features, which effectively forces the model to instead seek plausibility with respect to the remaining features. This in turn results in lower overall sensitivity to immutable features, which we demonstrate empirically for different classifiers in @sec-experiments. Under certain conditions, this results holds theoretically[For the proof, see the supplementary appendix.]:\n\n::: {#thm-mtblty}\n\n## Protecting Immutable Features\n\nLet $f_\\theta(\\mathbf{x})=\\mathcal{S}(\\mathbf{M}_\\theta(\\mathbf{x}))=\\mathcal{S}(\\Theta\\mathbf{x})$ denote a linear classifier with softmax activation $\\mathcal{S}$ (i.e. *multinomial logistic regression*) where $y\\in\\{1,...,K\\}=\\mathcal{K}$ and $\\mathbf{x} \\in \\mathbb{R}^D$. If we assume multivariate Gaussian class densities with common diagonal covariance matrix $\\Sigma_k=\\Sigma$ for all $k \\in \\mathcal{K}$, then protecting an immutable feature from the contrastive divergence penalty (@eq-div) will result in lower classifier sensitivity to that feature relative to the remaining features, provided that at least one of those is mutable.\n\n:::\n\nIt is worth highlighting that @thm-mtblty assumes independence of features. This raises a valid concern about the effect of protecting immutable features in the presence of proxy features that remain unprotected. We discuss this limitation in @sec-discussion.\n\n## Illustration\n\nTo better convey the intuition underlying our proposed method, we illustrate different model outcomes in @exm-grad.\n\n::: {#exm-grad}\n\n## Prediction of Consumer Credit Default\n\nSuppose we are interested in predicting the likelihood that loan applicants default on their credit. We have access to historical data on previous loan takers comprised of a binary outcome variable ($y\\in\\{1=\\text{default},2=\\text{no default}\\}$) two input features: 1) the subjects' *age*, which we define as immutable, and 2) the subjects' existing level of *debt*, which we define as mutable. \n\nWe have simulated this scenario using synthetic data with independent features and Gaussian class-conditional densities in @fig-poc. The four panels in @fig-poc show the outcomes for different training procedures using the same model architecture each time (a linear classifier). In each case, we show the linear decision boundary (green) and the training data colored according to their ground-truth label: orange points belong to the target class, $y^+=2$, blue points belong to the non-target class, $y^-=1$. Stars indicate counterfactuals in the target class generated at test time using generic gradient descent for a fixed number of iterations.\n\nIn panel (a), we have trained our model conventionally, and we do not impose mutability constraints at test time. The generated counterfactuals are all valid, but not plausible: they are clearly distinguishable from the ground-truth data. In panel (b), we have trained our model with counterfactual training, once again not imposing mutability constraints at test time. We observe that the counterfactuals are clearly plausible, therefore meeting the first objective of @def-explainability.\n\nIn panel (c), we have used conventional training again, this time imposing the mutability constraint on *age* at test time. Counterfactuals are valid but involve some substantial reductions in *debt* for some individuals, in particular very young applicants. By comparison, counterfactual paths are shorter on average in panel (d), where we have used counterfactual training and protected immutable features as described in @sec-constraints. In particular, we observe that due to the classifier's lower sensitivity to *age*, recourse recommendations with respect to *debt* are much more homogenous, in that they do not disproportionately punish younger individuals. The counterfactuals are also plausible with respect to the mutable feature. Thus, we consider the model in panel (d) as the most explainable according to @def-explainability.\n\n:::\n\n![Visual illustration of how counterfactual training improves explainability. See @exm-grad for details.](/paper/figures/poc.svg){#fig-poc}\n\n\n\n# Experiments {#sec-experiments}\n\nIn this section, we present experiments that we have conducted in order to answer the following research questions:\n\n::: {#cor-plaus}\n\n## Plausibility\n\nDoes our proposed counterfactual training objective (@eq-obj) induce models to learn plausible explanations?\n\n:::\n\n::: {#cor-action}\n\n## Actionability\n\nDoes our proposed counterfactual training objective (@eq-obj) yield more favorable algorithmic recourse outcomes in the presence of actionability constraints?\n\n:::\n\nBeyond this, we are also interested in understanding how robust our answers to @cor-plaus and @cor-action are:\n\n::: {#cor-hyper}\n\n## Hyperparameters \n\nWhat are the effects of different hyperparameter choices with respect to @eq-obj?\n\n:::\n\n\n## Experimental Setup\n\n## Experimental Results\n\n\n\n# Discussion {#sec-discussion}\n\n1. Limited to classification models.\n2. Proxy attributes of immutable features.\n\n\n\n# Conclusion {#sec-conclusion}\n\n\n\n\n\n# References {-}\n\n::: {#refs}\n:::\n\n\n\n{{< pagebreak >}}\n\n\n\n\n\n\n\n\n\n\\FloatBarrier\n\n\\setcounter{section}{0}\n\\renewcommand{\\thesection}{\\Alph{section}}\n\n\\setcounter{table}{0}\n\\renewcommand{\\thetable}{A\\arabic{table}}\n\n\\setcounter{figure}{0}\n\\renewcommand{\\thefigure}{A\\arabic{figure}}\n\n<!-- # Supplementary Material {.appendix} -->\n\n# Notation {.appendix}\n\n- $y^+$: The target class and also the index of the target class.\n- $y^-$: The non-target class and also the index of non-the target class.\n- $\\mathbf{y}^+$: The one-hot encoded output vector for the target class. \n- $\\theta$: Model parameters (unspecified).\n- $\\Theta$: Matrix of parameters. \n\n# Technical Details of Our Approach {.appendix} \n\n\n\n\n\n\n## Protecting Mutability Constraints with Linear Classifiers {#sec-app-constraints}\n\nIn @sec-constraints we explain that to avoid penalizing implausibility that arises due to mutability constraints, we impose a point mass prior on $p(\\mathbf{x})$ for the corresponding feature. We argue in @sec-constraints that this approach induces models to be less sensitive to immutable features and demonstrate this empirically in @sec-experiments. Below we derive the analytical results in @thm-mtblty.\n\n::: {.proof}\n\nLet $d_{\\text{mtbl}}$ and $d_{\\text{immtbl}}$ denote some mutable and immutable feature, respectively. Suppose that $\\mu_{y^-,d_{\\text{immtbl}}} < \\mu_{y^+,d_{\\text{immtbl}}}$ and $\\mu_{y^-,d_{\\text{mtbl}}} > \\mu_{y^+,d_{\\text{mtbl}}}$, where $\\mu_{k,d}$ denotes the conditional sample mean of feature $d$ in class $k$. In words, we assume that the immutable feature tends to take lower values for samples in the non-target class $y^-$ than in the target class $y^+$. We assume the opposite to hold for the mutable feature.\n\nAssuming multivariate Gaussian class densities with common diagonal covariance matrix $\\Sigma_k=\\Sigma$ for all $k \\in \\mathcal{K}$, we have for the log likelihood ratio between any two classes $k,m \\in \\mathcal{K}$ [@hastie2009elements]:\n\n$$\n\\log \\frac{p(k|\\mathbf{x})}{p(m|\\mathbf{x})}=\\mathbf{x}^\\intercal \\Sigma^{-1}(\\mu_{k}-\\mu_{m})  + \\text{const}\n$$ {#eq-loglike}\n\nBy independence of $x_1,...,x_D$, the full log-likelihood ratio decomposes into:\n\n$$\n\\log \\frac{p(k|\\mathbf{x})}{p(m|\\mathbf{x})} = \\sum_{d=1}^D \\frac{\\mu_{k,d}-\\mu_{m,d}}{\\sigma_{d}^2} x_{d} + \\text{const}\n$$ {#eq-loglike-decomp}\n\nBy the properties of our classifier (*multinomial logistic regression*), we have:\n\n$$\n\\log \\frac{p(k|\\mathbf{x})}{p(m|\\mathbf{x})} = \\sum_{d=1}^D \\left( \\theta_{k,d} - \\theta_{m,d} \\right)x_d + \\text{const}\n$$ {#eq-multi}\n\nwhere $\\theta_{k,d}=\\Theta[k,d]$ denotes the coefficient on feature $d$ for class $k$. \n\nBased on @eq-loglike-decomp and @eq-multi we can identify that $(\\mu_{k,d}-\\mu_{m,d}) \\propto (\\theta_{k,d} - \\theta_{m,d})$ under the assumptions we made above. Hence, we have that $(\\theta_{y^-,d_{\\text{immtbl}}} - \\theta_{y^+,d_{\\text{immtbl}}}) < 0$ and $(\\theta_{y^-,d_{\\text{mtbl}}} - \\theta_{y^+,d_{\\text{mtbl}}}) > 0$\n\nLet $\\mathbf{x}^\\prime$ denote some randomly chosen individual from class $y^-$ and let $y^+ \\sim p(y)$ denote the randomly chosen target class. Then the partial derivative of the contrastive divergence penalty [@eq-div] with respect to coefficient $\\theta_{y^+,d}$ is equal to \n\n$$\n\\frac{\\partial}{\\partial\\theta_{y^+,d}} \\left(\\text{div}(\\mathbf{x},\\mathbf{x^\\prime},\\mathbf{y};\\theta)\\right) = \\frac{\\partial}{\\partial\\theta_{y^+,d}} \\left( \\left(-\\mathbf{M}_\\theta(\\mathbf{x})[y^+]\\right) - \\left(-\\mathbf{M}_\\theta(\\mathbf{x}^\\prime)[y^+]\\right) \\right) = x_{d}^\\prime - x_{d}\n$$ {#eq-grad}\n\nand equal to zero everywhere else.\n\nSince $(\\mu_{y^-,d_{\\text{immtbl}}} < \\mu_{y^+,d_{\\text{immtbl}}})$ we are more likely to have $(x_{d_{\\text{immtbl}}}^\\prime - x_{d_{\\text{immtbl}}}) < 0$ than vice versa at initialization. Similarly, we are more likely to have $(x_{d_{\\text{mtbl}}}^\\prime - x_{d_{\\text{mtbl}}}) > 0$ since $(\\mu_{y^-,d_{\\text{mtbl}}} > \\mu_{y^+,d_{\\text{mtbl}}})$.\n\nThis implies that if we do not protect feature $d_{\\text{immtbl}}$, the contrastive divergence penalty will push down on $\\theta_{y^-,d_{\\text{immtbl}}}$ thereby exacerbating the existing effect $(\\theta_{y^-,d_{\\text{immtbl}}} - \\theta_{y^+,d_{\\text{immtbl}}}) < 0$. In words, not protecting the immutable feature would have the undesirable effect of making the classifier more sensitive to this feature, in that it would be more likely to predict class $y^-$ as opposed to $y^+$ for lower values of $d_{\\text{immtbl}}$. \n\nBy the same rationale, the contrastive divergence penalty can generally be expected to push up on $\\theta_{y^-,d_{\\text{mtbl}}}$ exacerbating $(\\theta_{y^-,d_{\\text{mtbl}}} - \\theta_{y^+,d_{\\text{mtbl}}}) > 0$. In words, this has the effect of making the classifier more sensitive to the mutable feature, in that it would be more likely to predict class $y^-$ as opposed to $y^+$ for higher values of $d_{\\text{mtbl}}$.\n\nThus, our proposed approach of protecting feature $d_{\\text{immtbl}}$ has the net affect of decreasing the classifier's sensitivity to the immutable feature relative to the mutable feature (i.e. no change in sensitivity for $d_{\\text{immtbl}}$ relative to increased sensitivity for $d_{\\text{mtbl}}$).\n\n:::\n\n::: {.callout-warning}\n\n\\@Cynthia, \\@Arie, I have tentatively phrased the above in terms of a theorem and proof. This is something I've so far shied away from because I feel a bit out of my depth when it comes to mathematical proofs. The above makes intuitive sense to me, but I don't know for sure if it's correct. \n\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Detailed Results {.appendix}\n\n::: {.callout-warning}\n\n\\@Cynthia, \\@Arie, I'm including some preliminary results here but will rerun experiments in the coming days. You'll notice some odd outlier results (huge values) for the initial grid search (@sec-app-initial). My belief is that this is once again due to *ECCo* overshooting for some hyperparameter choices, that we have discussed before. A simple solution to this story is to actually impose domain constraints. Let's see what the final results show us (I also still plan to make slight changes to the implementation), but in any case I think it might even be worth to report results for the initial grid search in the final appendix (they do include good results for CT for certain hyperparameter ranges and highlight limitations inherited from energy-based modelling).\n\n:::\n\n## Qualitative Findings for Image Data\n\n::: {.callout-note}\n\n\\@Cynthia, \\@Arie, @fig-mnist shows much more plausible (faithful) counterfactuals for a model with CT than the model with conventional training (@fig-mnist-vanilla). In fact, this is not even using *ECCo+* and still showing better results than the best results we achieved in our AAAI paper for JEM ensembles.\n\n:::\n\n![Counterfactual images for *MLP* with counterfactual training. The underlying generator, *ECCo*, aims to generate counterfactuals that are faithful to the model [@altmeyer2024faithful].](/paper/figures/mnist_mlp.png){#fig-mnist}\n\n![Counterfactual images for *MLP* with conventional training. The underlying generator, *ECCo*, aims to generate counterfactuals that are faithful to the model [@altmeyer2024faithful].](/paper/figures/mnist_mlp_vanilla.png){#fig-mnist-vanilla}\n\n## Initial Grid Search {#sec-app-initial}\n\n\n\n\n\n\nFor the initial round of experiments we \n\n### Generator Parameters\n\nThe hyperparameter grids for the first investigation of the effect of generator parameters are shown in @exr-gen-params-first-run-train and @exr-gen-params-first-run-eval.\n\n::: {#exr-gen-params-first-run-train}\n\n## Training Phase\n\n\n- Generator Parameters:\n    - $\\lambda_{\\text{cost}}$: `0.0, 0.001, 0.1`\n    - $\\lambda_{\\text{div}}$: `0.01, 0.05, 0.1, 0.5, 1.0, 5.0, 10.0, 15.0`\n    - Learning Rate: `1.0`\n    - Maximum Iterations: `20, 50, 100`\n    - Optimizerimizer: `sgd`\n- Generator: `ecco, generic, omni, revise`\n- Training Parameters:\n    - Objective: `full, vanilla`\n\n\n\n\n\n:::\n\n\n::: {#exr-gen-params-first-run-eval}\n\n## Evaluation Phase\n\n\n- Counterfactual Parameters:\n    - Convergence: `max_iter`\n    - Maximum Iterations: `100`\n    - No. Individuals: `100`\n    - No. Runs: `5`\n- Generator Parameters:\n    - $\\lambda_{\\text{cost}}$: `0.0`\n    - $\\lambda_{\\text{div}}$: `0.1, 0.5, 1.0, 5.0, 10.0, 20.0`\n    - Learning Rate: `1.0`\n    - Maximum Iterations: `50`\n    - Optimizerimizer: `sgd`\n\n\n\n\n\n:::\n\n\n\n\n\n\n#### Linearly Separable \n\n- **Energy Penalty** (@tbl-lin_sep-lambda_energy_exper): *ECCo* generally does yield better results than *Vanilla* for higher choices of the energy penalty (10,15) during training. *Generic* performs poorly accross the board. *Omni* seems to have an anchoring effect, in that it never performs terribly but also never as good as the best *ECCo* results. *REVISE* performs poorly across the board.\n- **Cost** (@tbl-lin_sep-lambda_cost_exper): Results for all generators (except *Omni*) are quite bad, which can likely be attributed to extremely bad results for some choices of the **Energy Penalty** (results here are averaged). For *ECCo* and *Generic*, higher cost values generally lead to worse results.\n- **Maximum Iterations**: No clear patterns recognizable, so it seems that smaller choices are ok. \n- **Validity**: *ECCo* almost always valid except for very low values during training and high values at evaluation time. *Generic* often has poor validity.\n- **Accuracy**: Seems largely unaffected.\n\n\n\n\n\n\n::: {#tbl-lin_sep-lambda_energy_exper}\n\n::: {.content-hidden unless-format=\"pdf\"}\n\n\n\\begin{longtable}{ccccc}\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{div}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endfirsthead\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{div}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endhead\n  \\bottomrule\n  \\multicolumn{5}{r}{Continuing table below.}\\\\\n  \\bottomrule\n  \\endfoot\n  \\endlastfoot\n  full & 0.01 & \\textit{ECCo} & $-9.91 \\cdot 10^{11}$ & $2.25 \\cdot 10^{12}$ \\\\\n  full & 0.01 & \\textit{Generic} & $-5.71 \\cdot 10^{17}$ & $1.3 \\cdot 10^{18}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.01}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.54}} & \\color{blue}{\\textbf{0.116}} \\\\\n  full & 0.01 & \\textit{REVISE} & -15.6 & 13.2 \\\\\n  vanilla & 0.01 & \\textit{ECCo} & -4.28 & 3.52 \\\\\n  vanilla & 0.01 & \\textit{Generic} & -4.45 & 3.47 \\\\\n  vanilla & 0.01 & \\textit{Omniscient} & -5.12 & 4.46 \\\\\n  vanilla & 0.01 & \\textit{REVISE} & -4.91 & 4.24 \\\\\n  full & 0.05 & \\textit{ECCo} & $-5.63 \\cdot 10^{5}$ & $1.28 \\cdot 10^{6}$ \\\\\n  full & 0.05 & \\textit{Generic} & $-8.35 \\cdot 10^{17}$ & $1.9 \\cdot 10^{18}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.05}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.53}} & \\color{blue}{\\textbf{0.114}} \\\\\n  full & 0.05 & \\textit{REVISE} & -15 & 12.6 \\\\\n  vanilla & 0.05 & \\textit{ECCo} & -4.4 & 3.66 \\\\\n  vanilla & 0.05 & \\textit{Generic} & -4.38 & 3.48 \\\\\n  vanilla & 0.05 & \\textit{Omniscient} & -5.25 & 4.62 \\\\\n  vanilla & 0.05 & \\textit{REVISE} & -4.94 & 4.22 \\\\\n  full & 0.1 & \\textit{ECCo} & $-6.74 \\cdot 10^{5}$ & $1.53 \\cdot 10^{6}$ \\\\\n  full & 0.1 & \\textit{Generic} & $-1.71 \\cdot 10^{11}$ & $3.9 \\cdot 10^{11}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.1}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.56}} & \\color{blue}{\\textbf{0.124}} \\\\\n  full & 0.1 & \\textit{REVISE} & -15.6 & 13.2 \\\\\n  vanilla & 0.1 & \\textit{ECCo} & -4.28 & 3.52 \\\\\n  vanilla & 0.1 & \\textit{Generic} & -4.45 & 3.48 \\\\\n  vanilla & 0.1 & \\textit{Omniscient} & -5.12 & 4.46 \\\\\n  vanilla & 0.1 & \\textit{REVISE} & -4.91 & 4.25 \\\\\n  full & 0.5 & \\textit{ECCo} & -11.8 & 9.83 \\\\\n  full & 0.5 & \\textit{Generic} & $-1.06 \\cdot 10^{18}$ & $2.42 \\cdot 10^{18}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.5}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.54}} & \\color{blue}{\\textbf{0.123}} \\\\\n  full & 0.5 & \\textit{REVISE} & -15 & 12.6 \\\\\n  vanilla & 0.5 & \\textit{ECCo} & -4.4 & 3.65 \\\\\n  vanilla & 0.5 & \\textit{Generic} & -4.38 & 3.48 \\\\\n  vanilla & 0.5 & \\textit{Omniscient} & -5.25 & 4.61 \\\\\n  vanilla & 0.5 & \\textit{REVISE} & -4.95 & 4.22 \\\\\n  full & 1 & \\textit{ECCo} & -11.5 & 11.1 \\\\\n  full & 1 & \\textit{Generic} & $-1.71 \\cdot 10^{11}$ & $3.88 \\cdot 10^{11}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{1}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.59}} & \\color{blue}{\\textbf{0.117}} \\\\\n  full & 1 & \\textit{REVISE} & -15.7 & 13.3 \\\\\n  vanilla & 1 & \\textit{ECCo} & -4.28 & 3.51 \\\\\n  vanilla & 1 & \\textit{Generic} & -4.44 & 3.47 \\\\\n  vanilla & 1 & \\textit{Omniscient} & -5.11 & 4.46 \\\\\n  vanilla & 1 & \\textit{REVISE} & -4.91 & 4.25 \\\\\n  full & 5 & \\textit{ECCo} & -3.99 & 3.12 \\\\\n  full & 5 & \\textit{Generic} & $-4.88 \\cdot 10^{17}$ & $1.11 \\cdot 10^{18}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{5}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.53}} & \\color{blue}{\\textbf{0.117}} \\\\\n  full & 5 & \\textit{REVISE} & -14.6 & 12.1 \\\\\n  vanilla & 5 & \\textit{ECCo} & -4.4 & 3.65 \\\\\n  vanilla & 5 & \\textit{Generic} & -4.38 & 3.48 \\\\\n  vanilla & 5 & \\textit{Omniscient} & -5.25 & 4.61 \\\\\n  vanilla & 5 & \\textit{REVISE} & -4.95 & 4.22 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{10}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-2.31}} & \\color{blue}{\\textbf{0.735}} \\\\\n  full & 10 & \\textit{Generic} & $-1.7 \\cdot 10^{11}$ & $3.86 \\cdot 10^{11}$ \\\\\n  full & 10 & \\textit{Omniscient} & -2.53 & 0.117 \\\\\n  full & 10 & \\textit{REVISE} & -15.5 & 13 \\\\\n  vanilla & 10 & \\textit{ECCo} & -4.28 & 3.51 \\\\\n  vanilla & 10 & \\textit{Generic} & -4.44 & 3.47 \\\\\n  vanilla & 10 & \\textit{Omniscient} & -5.12 & 4.46 \\\\\n  vanilla & 10 & \\textit{REVISE} & -4.91 & 4.24 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{15}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-2.01}} & \\color{blue}{\\textbf{0.488}} \\\\\n  full & 15 & \\textit{Generic} & $-4.91 \\cdot 10^{17}$ & $1.12 \\cdot 10^{18}$ \\\\\n  full & 15 & \\textit{Omniscient} & -2.53 & 0.116 \\\\\n  full & 15 & \\textit{REVISE} & -14.4 & 11.7 \\\\\n  vanilla & 15 & \\textit{ECCo} & -4.4 & 3.65 \\\\\n  vanilla & 15 & \\textit{Generic} & -4.38 & 3.48 \\\\\n  vanilla & 15 & \\textit{Omniscient} & -5.25 & 4.6 \\\\\n  vanilla & 15 & \\textit{REVISE} & -4.95 & 4.23 \\\\\\bottomrule\n\\end{longtable}\n\n\n\n\n:::\n\nResults for Linearly Separable data by energy penalty.\n\n:::\n\n<!-- Cost -->\n\n\n\n\n\n\n::: {#tbl-lin_sep-lambda_cost_exper}\n\n::: {.content-hidden unless-format=\"pdf\"}\n\n\n\\begin{longtable}{ccccc}\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{cost}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endfirsthead\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{cost}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endhead\n  \\bottomrule\n  \\multicolumn{5}{r}{Continuing table below.}\\\\\n  \\bottomrule\n  \\endfoot\n  \\endlastfoot\n  full & 0 & \\textit{ECCo} & $-5.32 \\cdot 10^{3}$ & $1.21 \\cdot 10^{4}$ \\\\\n  full & 0 & \\textit{Generic} & $-1.03 \\cdot 10^{18}$ & $2.34 \\cdot 10^{18}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.64}} & \\color{blue}{\\textbf{0.125}} \\\\\n  full & 0 & \\textit{REVISE} & -15.4 & 12.9 \\\\\n  vanilla & 0 & \\textit{ECCo} & -4.34 & 3.58 \\\\\n  vanilla & 0 & \\textit{Generic} & -4.41 & 3.48 \\\\\n  vanilla & 0 & \\textit{Omniscient} & -5.18 & 4.54 \\\\\n  vanilla & 0 & \\textit{REVISE} & -4.93 & 4.23 \\\\\n  full & 0.001 & \\textit{ECCo} & -362 & 811 \\\\\n  full & 0.001 & \\textit{Generic} & $-2.65 \\cdot 10^{17}$ & $6.04 \\cdot 10^{17}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.001}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.49}} & \\color{blue}{\\textbf{0.115}} \\\\\n  full & 0.001 & \\textit{REVISE} & -15.5 & 13 \\\\\n  vanilla & 0.001 & \\textit{ECCo} & -4.34 & 3.58 \\\\\n  vanilla & 0.001 & \\textit{Generic} & -4.41 & 3.48 \\\\\n  vanilla & 0.001 & \\textit{Omniscient} & -5.18 & 4.53 \\\\\n  vanilla & 0.001 & \\textit{REVISE} & -4.93 & 4.23 \\\\\n  full & 0.1 & \\textit{ECCo} & $-3.72 \\cdot 10^{11}$ & $8.46 \\cdot 10^{11}$ \\\\\n  full & 0.1 & \\textit{Generic} & $-4.48 \\cdot 10^{14}$ & $1.02 \\cdot 10^{15}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.1}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-2.5}} & \\color{blue}{\\textbf{0.112}} \\\\\n  full & 0.1 & \\textit{REVISE} & -14.6 & 12.2 \\\\\n  vanilla & 0.1 & \\textit{ECCo} & -4.34 & 3.58 \\\\\n  vanilla & 0.1 & \\textit{Generic} & -4.41 & 3.48 \\\\\n  vanilla & 0.1 & \\textit{Omniscient} & -5.18 & 4.54 \\\\\n  vanilla & 0.1 & \\textit{REVISE} & -4.93 & 4.24 \\\\\\bottomrule\n\\end{longtable}\n\n\n\n\n:::\n\nResults for Linearly Separable data by cost penalty.\n\n:::\n\n\n#### Moons\n\n- **Energy Penalty** (@tbl-moons-lambda_energy_exper): *ECCo* consistently yields better results than *Vanilla*, except for very low choices of the energy penalty during training for which it performs abismal. *Generic* performs quite badly across the board for high enough choices of the energy penalty at evaluation time. *Omni* has small positive effect. *REVISE* performs poorly across the board.\n- **Cost (distance penalty)**: *Generic* generally does better for higher values, while *ECCo* does better for lower values.\n- **Maximum Iterations**: No clear patterns recognizable, so it seems that smaller choices are ok. \n- **Validity**: *ECCo* generally achieves full validity except for very low choices the energy penalty during training and high choices at evaluation time. *Generic* performs poorly for high choices of the energy penalty during evaluation.\n- **Accuracy**: Largely unaffected although *ECCo* suffers a bit for very low choices the energy penalty during training. *REVISE* suffers a lot in general (around 10 percentage points).\n\n\n\n\n\n\n::: {#tbl-moons-lambda_energy_exper}\n\n::: {.content-hidden unless-format=\"pdf\"}\n\n\n\\begin{longtable}{ccccc}\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{div}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endfirsthead\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{div}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endhead\n  \\bottomrule\n  \\multicolumn{5}{r}{Continuing table below.}\\\\\n  \\bottomrule\n  \\endfoot\n  \\endlastfoot\n  full & 0.01 & \\textit{ECCo} & $-2.8 \\cdot 10^{22}$ & $6.39 \\cdot 10^{22}$ \\\\\n  full & 0.01 & \\textit{Generic} & $-4.89 \\cdot 10^{30}$ & $1.11 \\cdot 10^{31}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.01}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-4.74}} & \\color{blue}{\\textbf{5.08}} \\\\\n  full & 0.01 & \\textit{REVISE} & -572 & $1.25 \\cdot 10^{3}$ \\\\\n  vanilla & 0.01 & \\textit{ECCo} & -15.5 & 17.3 \\\\\n  vanilla & 0.01 & \\textit{Generic} & -10.9 & 11.9 \\\\\n  vanilla & 0.01 & \\textit{Omniscient} & -12.7 & 14.4 \\\\\n  vanilla & 0.01 & \\textit{REVISE} & -11.2 & 13 \\\\\n  full & 0.05 & \\textit{ECCo} & $-1.55 \\cdot 10^{16}$ & $3.52 \\cdot 10^{16}$ \\\\\n  full & 0.05 & \\textit{Generic} & $-2.22 \\cdot 10^{20}$ & $5 \\cdot 10^{20}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.05}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-4.41}} & \\color{blue}{\\textbf{4.48}} \\\\\n  full & 0.05 & \\textit{REVISE} & $-1.04 \\cdot 10^{3}$ & $2.3 \\cdot 10^{3}$ \\\\\n  vanilla & 0.05 & \\textit{ECCo} & -15.5 & 17.2 \\\\\n  vanilla & 0.05 & \\textit{Generic} & -11.7 & 12.8 \\\\\n  vanilla & 0.05 & \\textit{Omniscient} & -12.4 & 14.1 \\\\\n  vanilla & 0.05 & \\textit{REVISE} & -11.3 & 13.1 \\\\\n  full & 0.1 & \\textit{ECCo} & $-3.41 \\cdot 10^{3}$ & $7.73 \\cdot 10^{3}$ \\\\\n  full & 0.1 & \\textit{Generic} & $-5.22 \\cdot 10^{30}$ & $1.19 \\cdot 10^{31}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.1}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-4.78}} & \\color{blue}{\\textbf{5.12}} \\\\\n  full & 0.1 & \\textit{REVISE} & -288 & 594 \\\\\n  vanilla & 0.1 & \\textit{ECCo} & -15.5 & 17.2 \\\\\n  vanilla & 0.1 & \\textit{Generic} & -10.9 & 11.9 \\\\\n  vanilla & 0.1 & \\textit{Omniscient} & -12.7 & 14.4 \\\\\n  vanilla & 0.1 & \\textit{REVISE} & -11.3 & 13.1 \\\\\n  full & 0.5 & \\textit{ECCo} & -7.09 & 7.51 \\\\\n  full & 0.5 & \\textit{Generic} & $-1.11 \\cdot 10^{31}$ & $2.53 \\cdot 10^{31}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.5}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-4.58}} & \\color{blue}{\\textbf{4.83}} \\\\\n  full & 0.5 & \\textit{REVISE} & $-1.19 \\cdot 10^{3}$ & $2.64 \\cdot 10^{3}$ \\\\\n  vanilla & 0.5 & \\textit{ECCo} & -15.5 & 17.2 \\\\\n  vanilla & 0.5 & \\textit{Generic} & -11.7 & 12.8 \\\\\n  vanilla & 0.5 & \\textit{Omniscient} & -12.4 & 14.1 \\\\\n  vanilla & 0.5 & \\textit{REVISE} & -11.3 & 13.1 \\\\\n  full & 1 & \\textit{ECCo} & -6.06 & 6.33 \\\\\n  full & 1 & \\textit{Generic} & $-1.58 \\cdot 10^{33}$ & $3.59 \\cdot 10^{33}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{1}} & \\color{blue}{\\textbf{Omniscient}} & \\color{blue}{\\textbf{-4.66}} & \\color{blue}{\\textbf{4.89}} \\\\\n  full & 1 & \\textit{REVISE} & $-1.16 \\cdot 10^{3}$ & $2.59 \\cdot 10^{3}$ \\\\\n  vanilla & 1 & \\textit{ECCo} & -15.5 & 17.3 \\\\\n  vanilla & 1 & \\textit{Generic} & -10.9 & 11.9 \\\\\n  vanilla & 1 & \\textit{Omniscient} & -12.7 & 14.4 \\\\\n  vanilla & 1 & \\textit{REVISE} & -11.3 & 13.1 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{5}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-2.57}} & \\color{blue}{\\textbf{2.07}} \\\\\n  full & 5 & \\textit{Generic} & $-1.17 \\cdot 10^{28}$ & $2.66 \\cdot 10^{28}$ \\\\\n  full & 5 & \\textit{Omniscient} & -4.29 & 4.31 \\\\\n  full & 5 & \\textit{REVISE} & -530 & $1.16 \\cdot 10^{3}$ \\\\\n  vanilla & 5 & \\textit{ECCo} & -15.5 & 17.2 \\\\\n  vanilla & 5 & \\textit{Generic} & -11.7 & 12.7 \\\\\n  vanilla & 5 & \\textit{Omniscient} & -12.4 & 14.1 \\\\\n  vanilla & 5 & \\textit{REVISE} & -11.3 & 13.1 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{10}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-1.76}} & \\color{blue}{\\textbf{0.974}} \\\\\n  full & 10 & \\textit{Generic} & $-1.54 \\cdot 10^{33}$ & $3.51 \\cdot 10^{33}$ \\\\\n  full & 10 & \\textit{Omniscient} & -4.44 & 4.56 \\\\\n  full & 10 & \\textit{REVISE} & $-1.52 \\cdot 10^{3}$ & $3.4 \\cdot 10^{3}$ \\\\\n  vanilla & 10 & \\textit{ECCo} & -15.5 & 17.3 \\\\\n  vanilla & 10 & \\textit{Generic} & -10.9 & 11.9 \\\\\n  vanilla & 10 & \\textit{Omniscient} & -12.7 & 14.4 \\\\\n  vanilla & 10 & \\textit{REVISE} & -11.3 & 13.1 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{15}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-1.37}} & \\color{blue}{\\textbf{0.365}} \\\\\n  full & 15 & \\textit{Generic} & $-5.32 \\cdot 10^{28}$ & $1.21 \\cdot 10^{29}$ \\\\\n  full & 15 & \\textit{Omniscient} & -4.34 & 4.38 \\\\\n  full & 15 & \\textit{REVISE} & -473 & $1.03 \\cdot 10^{3}$ \\\\\n  vanilla & 15 & \\textit{ECCo} & -15.5 & 17.2 \\\\\n  vanilla & 15 & \\textit{Generic} & -11.7 & 12.8 \\\\\n  vanilla & 15 & \\textit{Omniscient} & -12.4 & 14.1 \\\\\n  vanilla & 15 & \\textit{REVISE} & -11.3 & 13.1 \\\\\\bottomrule\n\\end{longtable}\n\n\n\n\n:::\n\nResults for Moons data by energy penalty.\n\n:::\n\n#### Circles\n\n- **Energy Penalty** (@tbl-circles-lambda_energy_exper): *ECCo* consistently yields better results than *Vanilla*, though primarily for low to medium choices of the energy penalty (<=5) during training. The same goes for *Generic*, which sometimes outperforms *ECCo* (for small energy penalty at evaluation time). *Omni* does alright for lower energy penalty at evaluation time, but loses out for higher choices. *REVISE* performs poorly across the board (except very low choices at evaluation time).\n- **Cost (distance penalty)**: *ECCo* and *Generic* generally achieve the best results when no cost penalty is used during training. Both *Omni* and *REVISE* are largely unaffected.\n- **Maximum Iterations**: *ECCo* consistently yields better results for higher numbers of iterations. *Generic* generally does best for a medium number (50). *Omni* is sometimes invalid (**???**).\n- **Validity**: *ECCo* tends to outperform its *Vanilla* counterpart, though primarily for low to medium choices of the energy penalty (<=5) during training and evaluation. *Vanilla* typically worse across the board.\n- **Accuracy**: Mostly unaffected, but *REVISE* again consistently some deterioration and *ECCo* deteriorates for high choices of energy penalty during training, reflecting other outcomes above.\n\n\n\n\n\n\n::: {#tbl-circles-lambda_energy_exper}\n\n::: {.content-hidden unless-format=\"pdf\"}\n\n\n\\begin{longtable}{ccccc}\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{div}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endfirsthead\n  \\toprule\n  \\textbf{Objective} & \\textbf{$\\lambda_{\\text{div}} (\\text{train})$} & \\textbf{Generator} & \\textbf{Value} & \\textbf{Std} \\\\\\midrule\n  \\endhead\n  \\bottomrule\n  \\multicolumn{5}{r}{Continuing table below.}\\\\\n  \\bottomrule\n  \\endfoot\n  \\endlastfoot\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.01}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-1.26}} & \\color{blue}{\\textbf{0.423}} \\\\\n  full & 0.01 & \\textit{Generic} & -1.49 & 0.71 \\\\\n  full & 0.01 & \\textit{Omniscient} & -5.21 & 5.25 \\\\\n  full & 0.01 & \\textit{REVISE} & $-2.71 \\cdot 10^{26}$ & $6.37 \\cdot 10^{26}$ \\\\\n  vanilla & 0.01 & \\textit{ECCo} & -9.33 & 7.34 \\\\\n  vanilla & 0.01 & \\textit{Generic} & -8.89 & 6.88 \\\\\n  vanilla & 0.01 & \\textit{Omniscient} & -8.67 & 6.87 \\\\\n  vanilla & 0.01 & \\textit{REVISE} & -8.65 & 6.8 \\\\\n  full & 0.05 & \\textit{ECCo} & -1.29 & 0.397 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.05}} & \\color{blue}{\\textbf{Generic}} & \\color{blue}{\\textbf{-1.21}} & \\color{blue}{\\textbf{0.356}} \\\\\n  full & 0.05 & \\textit{Omniscient} & -5.08 & 5.09 \\\\\n  full & 0.05 & \\textit{REVISE} & $-5.91 \\cdot 10^{27}$ & $1.36 \\cdot 10^{28}$ \\\\\n  vanilla & 0.05 & \\textit{ECCo} & -9.35 & 7.32 \\\\\n  vanilla & 0.05 & \\textit{Generic} & -8.85 & 6.87 \\\\\n  vanilla & 0.05 & \\textit{Omniscient} & -8.7 & 6.96 \\\\\n  vanilla & 0.05 & \\textit{REVISE} & -8.52 & 6.76 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.1}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-1.2}} & \\color{blue}{\\textbf{0.383}} \\\\\n  full & 0.1 & \\textit{Generic} & -1.5 & 0.735 \\\\\n  full & 0.1 & \\textit{Omniscient} & -5.17 & 5.23 \\\\\n  full & 0.1 & \\textit{REVISE} & $-3.06 \\cdot 10^{26}$ & $7.7 \\cdot 10^{26}$ \\\\\n  vanilla & 0.1 & \\textit{ECCo} & -9.33 & 7.32 \\\\\n  vanilla & 0.1 & \\textit{Generic} & -8.88 & 6.86 \\\\\n  vanilla & 0.1 & \\textit{Omniscient} & -8.69 & 6.9 \\\\\n  vanilla & 0.1 & \\textit{REVISE} & -8.68 & 6.81 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{0.5}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-1.12}} & \\color{blue}{\\textbf{0.217}} \\\\\n  full & 0.5 & \\textit{Generic} & -1.21 & 0.352 \\\\\n  full & 0.5 & \\textit{Omniscient} & -5.09 & 5.12 \\\\\n  full & 0.5 & \\textit{REVISE} & $-5.97 \\cdot 10^{27}$ & $1.37 \\cdot 10^{28}$ \\\\\n  vanilla & 0.5 & \\textit{ECCo} & -9.35 & 7.3 \\\\\n  vanilla & 0.5 & \\textit{Generic} & -8.89 & 6.92 \\\\\n  vanilla & 0.5 & \\textit{Omniscient} & -8.68 & 6.93 \\\\\n  vanilla & 0.5 & \\textit{REVISE} & -8.53 & 6.75 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{1}} & \\color{blue}{\\textbf{ECCo}} & \\color{blue}{\\textbf{-1.1}} & \\color{blue}{\\textbf{0.163}} \\\\\n  full & 1 & \\textit{Generic} & -1.49 & 0.726 \\\\\n  full & 1 & \\textit{Omniscient} & -5.16 & 5.2 \\\\\n  full & 1 & \\textit{REVISE} & $-3.09 \\cdot 10^{26}$ & $7.22 \\cdot 10^{26}$ \\\\\n  vanilla & 1 & \\textit{ECCo} & -9.34 & 7.36 \\\\\n  vanilla & 1 & \\textit{Generic} & -8.86 & 6.85 \\\\\n  vanilla & 1 & \\textit{Omniscient} & -8.7 & 6.9 \\\\\n  vanilla & 1 & \\textit{REVISE} & -8.69 & 6.85 \\\\\n  full & 5 & \\textit{ECCo} & -1.75 & 0.154 \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{5}} & \\color{blue}{\\textbf{Generic}} & \\color{blue}{\\textbf{-1.21}} & \\color{blue}{\\textbf{0.363}} \\\\\n  full & 5 & \\textit{Omniscient} & -5.14 & 5.16 \\\\\n  full & 5 & \\textit{REVISE} & $-1.1 \\cdot 10^{28}$ & $2.5 \\cdot 10^{28}$ \\\\\n  vanilla & 5 & \\textit{ECCo} & -9.36 & 7.32 \\\\\n  vanilla & 5 & \\textit{Generic} & -8.88 & 6.91 \\\\\n  vanilla & 5 & \\textit{Omniscient} & -8.7 & 6.93 \\\\\n  vanilla & 5 & \\textit{REVISE} & -8.52 & 6.73 \\\\\n  full & 10 & \\textit{ECCo} & $-1.02 \\cdot 10^{6}$ & $2.32 \\cdot 10^{6}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{10}} & \\color{blue}{\\textbf{Generic}} & \\color{blue}{\\textbf{-1.49}} & \\color{blue}{\\textbf{0.702}} \\\\\n  full & 10 & \\textit{Omniscient} & -5.13 & 5.16 \\\\\n  full & 10 & \\textit{REVISE} & $-3.74 \\cdot 10^{26}$ & $9.09 \\cdot 10^{26}$ \\\\\n  vanilla & 10 & \\textit{ECCo} & -9.31 & 7.33 \\\\\n  vanilla & 10 & \\textit{Generic} & -8.87 & 6.86 \\\\\n  vanilla & 10 & \\textit{Omniscient} & -8.7 & 6.89 \\\\\n  vanilla & 10 & \\textit{REVISE} & -8.69 & 6.83 \\\\\n  full & 15 & \\textit{ECCo} & $-3.31 \\cdot 10^{13}$ & $7.54 \\cdot 10^{13}$ \\\\\n  \\color{blue}{\\textbf{full}} & \\color{blue}{\\textbf{15}} & \\color{blue}{\\textbf{Generic}} & \\color{blue}{\\textbf{-1.22}} & \\color{blue}{\\textbf{0.37}} \\\\\n  full & 15 & \\textit{Omniscient} & -5.2 & 5.23 \\\\\n  full & 15 & \\textit{REVISE} & $-9.01 \\cdot 10^{27}$ & $2.06 \\cdot 10^{28}$ \\\\\n  vanilla & 15 & \\textit{ECCo} & -9.38 & 7.34 \\\\\n  vanilla & 15 & \\textit{Generic} & -8.86 & 6.87 \\\\\n  vanilla & 15 & \\textit{Omniscient} & -8.69 & 6.96 \\\\\n  vanilla & 15 & \\textit{REVISE} & -8.51 & 6.73 \\\\\\bottomrule\n\\end{longtable}\n\n\n\n\n:::\n\nResults for Circles data by energy penalty.\n\n:::\n\n",
    "supporting": [
      "paper_files"
    ],
    "filters": []
  }
}